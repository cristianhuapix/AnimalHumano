<div class="container mx-auto px-4 py-8">
  <div class="flex items-center mb-6">
    <button (click)="goBack()" class="btn-back">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"></path>
      </svg>
    </button>
    <h1 class="text-3xl font-bold">üîç Buscar Servicios</h1>
  </div>

  <!-- Filters Section -->
  <div class="bg-white shadow-md rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Filtros</h2>

    <!-- Filter Dropdowns -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Category Filter -->
      <div>
        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
          Categor√≠a
        </label>
        <select
          #categorySelect
          id="category"
          (change)="onCategorySelect(categorySelect.value); categorySelect.value = ''"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Seleccionar categor√≠a...</option>
          @for (cat of categories(); track cat.code) {
            @if (cat.code !== 'all' && !selectedCategories().includes(cat.code)) {
              <option [value]="cat.code">{{ cat.name }}</option>
            }
          }
        </select>
      </div>

      <!-- Service Type Filter -->
      <div>
        <label for="serviceType" class="block text-sm font-medium text-gray-700 mb-2">
          Tipo de Servicio
        </label>
        <select
          #serviceTypeSelect
          id="serviceType"
          (change)="onServiceTypeSelect(serviceTypeSelect.value); serviceTypeSelect.value = ''"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Seleccionar servicio...</option>
          @for (st of filteredServiceTypes(); track st.id) {
            @if (!selectedServiceTypes().includes(st.id)) {
              <option [value]="st.id">{{ st.name }}</option>
            }
          }
        </select>
      </div>

      <!-- Distance Filter -->
      <div>
        <label for="distance" class="block text-sm font-medium text-gray-700 mb-2">
          Distancia m√°xima: {{ maxDistance() }} km
        </label>
        <input
          type="range"
          id="distance"
          min="1"
          max="100"
          step="5"
          [value]="maxDistance()"
          (input)="onDistanceChange(+$any($event.target).value)"
          class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
      </div>
    </div>

    <!-- Selected Filters as Chips -->
    @if (selectedCategories().length > 0 || selectedServiceTypes().length > 0) {
      <div class="selected-filters-chips">
        @for (catCode of selectedCategories(); track catCode) {
          <button class="filter-chip chip-removable" (click)="removeCategory(catCode)">
            {{ getCategoryName(catCode) }}
            <span class="chip-remove">‚úï</span>
          </button>
        }
        @for (stId of selectedServiceTypes(); track stId) {
          <button class="filter-chip chip-removable" (click)="removeServiceType(stId)">
            {{ getServiceTypeName(stId) }}
            <span class="chip-remove">‚úï</span>
          </button>
        }
      </div>
    }
  </div>

  <!-- Results Section -->
  @if (error()) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      {{ error() }}
    </div>
  }

  @if (loading()) {
    <div class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600">Buscando servicios...</p>
    </div>
  } @else if (services().length === 0) {
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
      <svg class="mx-auto h-16 w-16 text-blue-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <p class="text-xl text-gray-600 mb-2">No se encontraron servicios</p>
      <p class="text-gray-500">Intent√° cambiar los filtros de b√∫squeda</p>
    </div>
  } @else {
    <div class="services-list">
      @for (service of services(); track service.id) {
        <div class="service-list-item">
          <!-- Left side: Service info (clickable) -->
          <div class="service-info" (click)="openProviderModal(service.provider_id)">
            <div class="service-icon">
              {{ service.service_type?.icon || 'üîß' }}
            </div>
            <div class="service-details">
              <div class="service-title-row">
                <h3 class="service-title">
                  {{ service.custom_name || service.providers?.business_name }}
                </h3>
                <span class="category-badge category-{{ service.service_type?.category }}">
                  {{ getCategoryInSpanish(service.service_type?.category) }}
                </span>
              </div>
              <p class="service-type">
                {{ service.service_type?.name }}
              </p>
              @if (service.providers?.address) {
                <p class="service-location">
                  üìç {{ service.providers?.city }}
                  @if (service.providers?.distance) {
                    <span class="service-distance">‚Ä¢ {{ service.providers?.distance | number:'1.1-1' }} km</span>
                  }
                </p>
              }
            </div>
          </div>

          <!-- Right side: Ratings and reviews (clickable) -->
          <div class="service-rating" (click)="viewProviderReviews(service.provider_id)">
            <div class="rating-display">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="star-icon">
                <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
              </svg>
              <span class="rating-value">{{ service.providers?.rating || 0 | number:'1.1' }}</span>
              <span class="rating-count">({{ service.providers?.rating_count || 0 }})</span>
            </div>
            <button class="see-details-btn">
              seeDetails ‚Üí
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Provider Details Modal -->
@if (showProviderModal()) {
  <div class="modal-overlay" (click)="closeProviderModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title">Detalles del Proveedor</h2>
        <button class="modal-close" (click)="closeProviderModal()">
          ‚úï
        </button>
      </div>

      <!-- Loading State -->
      @if (loadingProviderDetails()) {
        <div class="modal-body">
          <div class="flex flex-col items-center justify-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Cargando informaci√≥n...</p>
          </div>
        </div>
      } @else if (selectedProviderDetails()) {
        <!-- Modal Body -->
        <div class="modal-body">
          @if (selectedProviderDetails()?.provider) {
            <!-- Business Name -->
            <div class="provider-section">
              <h3 class="provider-name">
                {{ selectedProviderDetails()!.provider.business_name }}
              </h3>
            </div>

            <!-- Rating -->
            <div class="provider-section">
              <div class="rating-display-large">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="star-icon-large">
                  <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                </svg>
                <span class="rating-value-large">{{ selectedProviderDetails()!.provider.rating || 0 | number:'1.1' }}</span>
                <span class="rating-count-large">({{ selectedProviderDetails()!.provider.rating_count || 0 }} calificaciones)</span>
              </div>
            </div>

            <!-- Description -->
            @if (selectedProviderDetails()!.provider.description) {
              <div class="provider-section">
                <h4 class="section-title">Descripci√≥n</h4>
                <p class="section-text">{{ selectedProviderDetails()!.provider.description }}</p>
              </div>
            }

            <!-- Address -->
            @if (selectedProviderDetails()!.provider.address) {
              <div class="provider-section">
                <h4 class="section-title">Direcci√≥n</h4>
                <p class="section-text">
                  üìç {{ selectedProviderDetails()!.provider.address }}
                  @if (selectedProviderDetails()!.provider.city) {
                    , {{ selectedProviderDetails()!.provider.city }}
                  }
                  @if (selectedProviderDetails()!.provider.province) {
                    , {{ selectedProviderDetails()!.provider.province }}
                  }
                </p>
              </div>
            }

          }
        </div>

        <!-- Modal Footer with Actions -->
        <div class="modal-footer">
          @if (authService.currentUser()?.id !== selectedProviderDetails()!.provider.id) {
            <button
              class="btn btn-primary"
              (click)="contactProvider(selectedProviderDetails()!.provider.id)">
              üí¨ Contactar
            </button>

            @if (selectedProviderDetails()!.has_contacted && selectedProviderDetails()!.can_rate) {
              <button
                class="btn btn-secondary"
                (click)="openRatingModal()">
                ‚≠ê Calificar
              </button>
            }

            @if (selectedProviderDetails()!.has_contacted && !selectedProviderDetails()!.can_rate) {
              <p class="text-sm text-gray-500 mt-2">
                Ya calificaste a este proveedor recientemente. Podr√°s volver a calificarlo despu√©s del
                {{ selectedProviderDetails()!.last_rating_date }}
              </p>
            }

            @if (!selectedProviderDetails()!.has_contacted) {
              <p class="text-sm text-gray-500 mt-2">
                Debes contactar al proveedor antes de poder calificarlo
              </p>
            }
          } @else {
            <p class="text-sm text-gray-500 mt-2">
              Este es tu perfil de proveedor
            </p>
          }
        </div>
      }
    </div>
  </div>
}
