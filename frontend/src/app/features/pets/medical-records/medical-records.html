<div class="medical-records-container container">
  <!-- Header -->
  <div class="header">
    <button routerLink="/pets" class="btn-back">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"></path>
      </svg>
    </button>
    <h1>Historias Médicas - {{ pet()?.name }}</h1>
    <button class="btn-add" (click)="openAddModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Agregar Historia
    </button>
  </div>

  @if (errorMessage()) {
    <div class="error-message">
      {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="spinner"></div>
  }

  <!-- Medical Records List -->
  <div class="records-list">
    @if (medicalRecords().length === 0 && !isLoading()) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 2v2"></path>
          <path d="M5 2v2"></path>
          <path d="M5 3H4a2 2 0 0 0-2 2v4a6 6 0 0 0 12 0V5a2 2 0 0 0-2-2h-1"></path>
          <path d="M8 15a6 6 0 0 0 12 0v-3"></path>
          <circle cx="20" cy="10" r="2"></circle>
        </svg>
        <p>No hay historias médicas registradas</p>
        <button class="btn-primary" (click)="openAddModal()">Agregar Primera Historia</button>
      </div>
    } @else {
      @for (record of medicalRecords(); track record.id) {
        <div class="record-card">
          <div class="record-header">
            <h3>{{ record.title }}</h3>
            <div class="record-actions">
              @if (record.attachments && record.attachments.length > 0) {
                @for (attachment of record.attachments; track attachment.url) {
                  <button class="btn-view-attachment" (click)="openAttachment(attachment.url)" title="Ver Archivo/Foto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <circle cx="10" cy="13" r="2"></circle>
                      <path d="m20 17-1.09-1.09a2 2 0 0 0-2.82 0L10 22"></path>
                    </svg>
                  </button>
                }
              }
              <button class="btn-icon-delete" title="Eliminar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                  <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="record-meta">
            <div class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
                <line x1="16" x2="16" y1="2" y2="6"></line>
                <line x1="8" x2="8" y1="2" y2="6"></line>
                <line x1="3" x2="21" y1="10" y2="10"></line>
              </svg>
              <span>{{ formatDate(record.date) }}</span>
            </div>
            <div class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>{{ record.created_by_name || 'Veterinario' }}</span>
            </div>
          </div>
          <div class="record-body">
            <p class="record-description">{{ record.description }}</p>
          </div>
        </div>
      }
    }
  </div>

  <!-- Add Record Modal -->
  @if (showAddModal()) {
    <div class="modal-overlay" (click)="closeAddModal()">
      <div class="modal-content modal-add-record" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Agregar Historia Médica</h3>
          <button class="btn-close" (click)="closeAddModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          @if (errorMessage()) {
            <div class="error-message">
              {{ errorMessage() }}
            </div>
          }

          <div class="form-group">
            <label for="date">Fecha *</label>
            <input
              type="date"
              id="date"
              [value]="newRecord().date"
              (input)="updateField('date', $any($event.target).value)"
              [max]="maxDate">
          </div>

          <div class="form-group">
            <label for="title">Título *</label>
            <input
              type="text"
              id="title"
              placeholder="Ej: Consulta de rutina"
              [value]="newRecord().title"
              (input)="updateField('title', $any($event.target).value)">
          </div>

          <div class="form-group">
            <label for="description">Descripción *</label>
            <textarea
              id="description"
              rows="4"
              placeholder="Describe los síntomas, diagnóstico, tratamiento, etc."
              [value]="newRecord().description"
              (input)="updateField('description', $any($event.target).value)"></textarea>
          </div>

          <div class="form-group">
            <label>Adjuntar Archivo</label>
            <div class="file-options">
              <button type="button" class="btn-file-option" (click)="fileInput.click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Elegir Archivo
              </button>
              <button type="button" class="btn-file-option" (click)="openCamera()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
                Tomar Foto
              </button>
              <input
                #fileInput
                type="file"
                accept="image/*,.pdf"
                (change)="onFileSelected($event)"
                style="display: none;">
            </div>

            @if (selectedFile()) {
              <div class="file-preview">
                @if (selectedFilePreview()) {
                  <img [src]="selectedFilePreview()!" alt="Preview">
                }
                <div class="file-info">
                  <span class="file-name">{{ selectedFile()!.name }}</span>
                  <button type="button" class="btn-remove-file" (click)="removeFile()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeAddModal()" [disabled]="isSaving()">Cancelar</button>
          <button class="btn-save" (click)="saveRecord()" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="spinner-small"></span>
              Guardando...
            } @else {
              Guardar
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Camera Modal -->
  @if (showCameraModal()) {
    <div class="modal-overlay camera-overlay" (click)="closeCameraModal()">
      <div class="modal-content modal-camera" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Tomar Foto</h3>
          <button class="btn-close" (click)="closeCameraModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body camera-body">
          <video #videoElement autoplay playsinline class="camera-video"></video>
          <canvas #canvasElement style="display: none;"></canvas>
        </div>
        <div class="modal-footer camera-footer">
          <button class="btn-cancel" (click)="closeCameraModal()">Cancelar</button>
          <button class="btn-capture" (click)="capturePhoto()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
            Capturar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Image Modal -->
  @if (showImageModal()) {
    <div class="modal-overlay" (click)="closeImageModal()">
      <div class="modal-content modal-image" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Archivo Médico</h3>
          <div class="modal-actions">
            <button class="btn-icon-action" (click)="downloadAttachment()" title="Descargar">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="btn-icon-action" (click)="shareAttachment()" title="Compartir">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
            <button class="btn-close" (click)="closeImageModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body image-body">
          <img [src]="currentImageUrl()" alt="Archivo médico" />
        </div>
      </div>
    </div>
  }
</div>
